<!doctype html>
<!--
Copyright 2022 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description"
        content="Sample illustrating the use of Web Bluetooth / Discover Services & Characteristics.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Web Bluetooth / Discover Services & Characteristics Sample</title>
    <script>
        // Add a global error event listener early on in the page load, to help ensure that browsers
        // which don't support specific functionality still end up displaying a meaningful message.
        window.addEventListener('error', function (error) {
            if (ChromeSamples && ChromeSamples.setStatus) {
                console.error(error);
                ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
                error.preventDefault();
            }
        });
    </script>
    <style>
        .config_label {
            /* margin-right: 20px; */
            font-weight: bold;
            display: inline-block;
            width: 150px;
        }
        .config_input {
            width: 50px;
        }
        .config_input_longer {
            width: 130px;
        }
        .debug-scroll {
            border-left: solid 1px black;
            /* display: block; */
            height: 80px;
            overflow-y: scroll;
        }
        button {
            margin-left: 10px;
            margin-right: 5px;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <h3>Connect Device:</h3>
    <form>
        <button id="btn-connect">Select Device</button>
        <span id="lbl-connected">Not connected</span>
        <button id="btn-disconnect">Disconnect</button>
    </form>

    <h3>Configuration</h3>
    <p>Config options are <b>application specific</b></p>
    <div>
        <span class="config_label">Uplink interval</span>
        <input class="config_input" type="text" id="inp_uplink" />
        <button id="but_get_uplink">Read</button>
        <button id="but_set_uplink">Write</button>
    </div>
    <div>
        <span class="config_label">Sensor interval</span>
        <input class="config_input" type="text" id="inp_sense" />
        <button id="but_get_sense">Read</button>
        <button id="but_set_sense">Write</button>
    </div>
    <div>
        <span class="config_label">GPS interval</span>
        <input class="config_input" type="text" id="inp_gps" />
        <button id="but_get_gps">Read</button>
        <button id="but_set_gps">Write</button>
    </div>
    <div>
        <span class="config_label">Commission state</span>
        <!-- <input class="config_input" type="text" id="inp_comm" /> -->
        <input class="config_input" type="checkbox" id="inp_comm" />
        <button id="but_get_comm">Read</button>
        <button id="but_set_comm">Write</button>
    <div>
    <div>
        <span class="config_label">MNO/Carrier</span>
        <input class="config_input" type="text" id="inp_mno" />
        <button id="but_get_mno">Read</button>
        <button id="but_set_mno">Write</button>
    </div>
        <span class="config_label">Network APN</span>
        <input class="config_input_longer" type="text" id="inp_apn" />
        <button id="but_get_apn">Read</button>
        <button id="but_set_apn">Write</button>
    </div>
    <div>
        <span class="config_label">Server IP, port</span>
        <input class="config_input_longer" type="text" id="inp_url" />
        <input class="config_input" type="number" id="inp_port" />
        <button id="but_get_url">Read</button>
        <button id="but_set_url">Write</button>
    </div>

    <div>
        <span class="config_label">Test action</span>
        <input class="config_input" type="text" id="inp_test" />
        <button id="but_set_test">Write</button>
        <button id="but_get_test">Read</button>
    </div>
    <p></p>
    <div>
        <button id="but_set_factory_reset">Factory Reset</button>
        <button id="but_set_reboot">Reboot</button>
    </div>
    <p></p>
    <div>
        <h4>Analog/Pulse App</h4>
        <span class="config_label">Tilt angle trigger</span>
        <input class="config_input" type="text" id="inp_tilt_trig" />
        <br/>
        <span class="config_label">Tilt angle offset</span>
        <input class="config_input" type="text" id="inp_tilt_off" />
        <br/>
        <span class="config_label">Pulse event enable</span>
        <input class="config_input" type="checkbox" id="inp_pulse_ev" />
        <br/>
        <span class="config_label">Transmit delay</span>
        <input class="config_input" type="text" id="inp_tx_delay" />
        <br/>
        <span class="config_label">Analog threshold</span>
        <input class="config_input config_input_longer" type="text" id="inp_an_thresh" />
        <br/>
        <button id="but_get_analog">Read</button>
        <button id="but_set_analog">Write</button>
    </div>
    <p></p>
    <div>
        <span class="config_label">Modem diagnostic</span>
        <button id="but_diag_wake">Wake</button>
        <button id="but_diag_sleep">Sleep</button>
        <button id="but_diag_cell">Cell Info</button>
        <button id="but_diag_sim">SIM Info</button>
        <button id="but_diag_gps_start">GPS Start</button>
        <button id="but_diag_gps_stop">GPS Stop</button>
        <button id="but_diag_gps_stat">GPS Status</button>
        <pre id="debug_log" class="debug-scroll">&nbsp;</pre>
    </div>

    <h3>Output</h3>
    <div id="output" class="output">
        <div id="content"></div>
        <div id="status"></div>
        <pre id="log"></pre>
    </div>


    <script>
        var ChromeSamples = {
            log: function () {
                var line = Array.prototype.slice.call(arguments).map(function (argument) {
                    return typeof argument === 'string' ? argument : JSON.stringify(argument);
                }).join(' ');

                document.querySelector('#log').textContent += line + '\n';
            },

            clearLog: function () {
                document.querySelector('#log').textContent = '';
            },

            setStatus: function (status) {
                document.querySelector('#status').textContent = status;
            },

            setContent: function (newContent) {
                var content = document.querySelector('#content');
                while (content.hasChildNodes()) {
                    content.removeChild(content.lastChild);
                }
                content.appendChild(newContent);
            }
        };
    </script>
    <script>
        if (/Chrome\/(\d+\.\d+.\d+.\d+)/.test(navigator.userAgent)) {
            // Let's log a warning if the sample is not supposed to execute on this
            // version of Chrome.
            if (53 > parseInt(RegExp.$1)) {
                ChromeSamples.setStatus('Warning! Keep in mind this sample has been tested with Chrome ' + 53 + '.');
            }
        }

        log = ChromeSamples.log;

        function isWebBluetoothEnabled() {
            if (navigator.bluetooth) {
                return true;
            } else {
                ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                    'Please make sure the "Experimental Web Platform features" flag is enabled.');
                return false;
            }
        }

        let encoder = new TextEncoder('utf-8');
        let decoder = new TextDecoder('utf-8');

        /* Document bindings */
        document.querySelector("#but_get_uplink").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.getUplink()
                .then((s) => {
                    document.querySelector("#inp_uplink").value = s;
                });
        });
        document.querySelector("#but_set_uplink").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setUplink( parseInt(document.querySelector("#inp_uplink").value) );
        });
        
        document.querySelector("#but_get_sense").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.getSenseInt()
                .then((s) => {
                    document.querySelector("#inp_sense").value = s;
                });
        });
        document.querySelector("#but_set_sense").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setSenseInt( parseInt(document.querySelector("#inp_sense").value) );
        });

        document.querySelector("#but_get_gps").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.getGps()
                .then((s) => {
                    document.querySelector("#inp_gps").value = s;
                });
        });
        document.querySelector("#but_set_gps").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setGps( parseInt(document.querySelector("#inp_gps").value) );
        });
        
        document.querySelector("#but_get_mno").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.getMno()
                .then((s) => {
                    document.querySelector("#inp_mno").value = s;
                });
        });
        document.querySelector("#but_set_mno").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setMno( parseInt(document.querySelector("#inp_mno").value) );
        });
        
        document.querySelector("#but_get_comm").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.getCommish()
                .then((s) => {
                    document.querySelector("#inp_comm").checked = (s == 1);
                });
        });
        document.querySelector("#but_set_comm").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setCommish( parseInt(document.querySelector("#inp_comm").checked ? 1 : 0) );
        });

        document.querySelector("#but_get_url").addEventListener('click', async function(evt) {
            evt.preventDefault();
            let s = await ewOptima.getUrl();
            document.querySelector("#inp_url").value = s.url;
            document.querySelector("#inp_port").vlue = s.port;
        });
        document.querySelector("#but_set_url").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setUrl( {url: document.querySelector("#inp_url").value, port: parseInt(document.querySelector("#inp_port").value) });
        });
        
        document.querySelector("#but_get_apn").addEventListener('click', async function(evt) {
            evt.preventDefault();
            document.querySelector("#inp_apn").value = await ewOptima.getApn();
        });
        document.querySelector("#but_set_apn").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setApn( document.querySelector("#inp_apn").value );
        });

        document.querySelector("#but_get_test").addEventListener('click', async function(evt) {
            evt.preventDefault();
            document.querySelector("#inp_test").value = await ewOptima.getTestAction();
        });
        document.querySelector("#but_set_test").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setTestAction( parseInt(document.querySelector("#inp_test").value) );
        });

        document.querySelector("#but_set_factory_reset").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setFactoryResetAction(0);
        });
        document.querySelector("#but_set_reboot").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setRebootAction(0);
        });


        
        // Analog App configs
        document.querySelector("#but_get_analog").addEventListener('click', async function(evt) {
            evt.preventDefault();
            let s = await ewOptima.getAnalog(); // : DataView ?
            console.log(s);

            document.querySelector("#inp_tilt_off").value = s.getInt32(0, false);
            document.querySelector("#inp_tilt_trig").value = s.getInt32(4, false);
            document.querySelector("#inp_tx_delay").value = s.getUint8(8);
            document.querySelector("#inp_an_thresh").value = s.getUint16(9, false) + "," + s.getUint16(11, false);
            document.querySelector("#inp_pulse_ev").checked = s.getInt8(13, false) == 1;
        });
        document.querySelector("#but_set_analog").addEventListener('click', function(evt) {
            evt.preventDefault();

            const buffer = new ArrayBuffer(32);
            const view = new DataView(buffer);

            view.setInt32(0,  parseInt(document.querySelector("#inp_tilt_off").value) );
            view.setInt32(4,  parseInt(document.querySelector("#inp_tilt_trig").value) );
            view.setUint8(8,  parseInt(document.querySelector("#inp_tx_delay").value) );
            
            let val = document.querySelector("#inp_an_thresh").value;
            let found = val.match(new RegExp(/(\d+)(\d+)/g));
            if (found.length != 2) {
                return;
            }
            view.setInt16(9, parseInt(found[0]) );
            view.setInt16(11, parseInt(found[1]) );
        
            view.setUint8(13, document.querySelector("#inp_pulse_ev").checked ? 1 : 0 );

            ewOptima.setAnalog( buffer );
        });        
        
        // Modem diag
        document.querySelector("#but_diag_wake").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 0 );
        });
        document.querySelector("#but_diag_sleep").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 1 );
        });
        document.querySelector("#but_diag_cell").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 2 );
        });
        document.querySelector("#but_diag_sim").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 5 );
        });
        document.querySelector("#but_diag_gps_start").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 7 );
        });
        document.querySelector("#but_diag_gps_stop").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 8 );
        });
        document.querySelector("#but_diag_gps_stat").addEventListener('click', function(evt) {
            evt.preventDefault();
            ewOptima.setDiagAction( 9 );
        });
        

        /* Custom Bluetooth Service UUIDs */
        //'0000fe40-cc7a-482a-984a-7f2ed5b3e58b'     // EW service
        const OPTIMA_SERVICE_UUID = '0000fe40-cc7a-482a-984a-7f2ed5b3e58b';

        /* Custom Bluetooth Characteristic UUIDs */

        const CONFIG_SENSE_UUID          = 0xCC01;
        const CONFIG_HB_INT_UUID         = 0xCC02;
        const CONFIG_GPS_INT_UUID        = 0xCC03;
        const CONFIG_MNO_UUID            = 0xCC04;
        const CONFIG_URL_UUID            = 0xCC05;
        const CONFIG_APN_UUID            = 0xCC06;
        const CONFIG_PORT_UUID           = 0xCC07;
        const CONFIG_MISC_UUID           = 0xCC08;
        const CONFIG_COMMISSION_UUID     = 0xCC0A;
        const CONFIG_CONTROL_UUID        = 0xCC0B;
        const MODEM_DEBUG_UUID           = 0xCC20;
        const CONFIG_FACTORT_RESET_UUID  = 0xCC21;
        const CONFIG_REBOOT_UUID         = 0xCC22;

        class EWOptima {
            constructor() {
                this.device = null;
                this.server = null;
                this._characteristics = new Map();
                this._debug = true;
            }
            connect() {
                let options = {
                    // filters: [
                    //     { services: [OPTIMA_SERVICE_UUID] }
                    // ],
                    acceptAllDevices: true,
                    optionalServices: [
                        'battery_service',
                        'device_information',
                        '8d53dc1d-1db7-4cd3-868b-8a527460aa84', // SMP
                        OPTIMA_SERVICE_UUID
                    ]
                };

                return navigator.bluetooth.requestDevice(options)
                    .then(device => {
                        this.device = device;
                        return device.gatt.connect();
                    })
                    .then(server => {
                        this.server = server;
                        return Promise.all([
                            server.getPrimaryService(OPTIMA_SERVICE_UUID).then(service => {
                                service.getCharacteristic(MODEM_DEBUG_UUID)
                                .then(characteristic => {
                                    characteristic.addEventListener('characteristicvaluechanged', function(event) {
                                            let decoder = new TextDecoder('utf-8');
                                            let txt = document.querySelector('#debug_log').textContent;
                                            document.querySelector('#debug_log').textContent = decoder.decode(event.target.value) + '\n' + txt;
                                            // log('> ' + decoder.decode(event.target.value));
                                        });
                                    characteristic.startNotifications();
                                });
                                return Promise.all([
                                    this._cacheCharacteristic(service, CONFIG_SENSE_UUID        ),
                                    this._cacheCharacteristic(service, CONFIG_HB_INT_UUID       ),
                                    this._cacheCharacteristic(service, CONFIG_GPS_INT_UUID      ),
                                    this._cacheCharacteristic(service, CONFIG_APN_UUID          ),
                                    this._cacheCharacteristic(service, CONFIG_URL_UUID          ),
                                    this._cacheCharacteristic(service, CONFIG_PORT_UUID         ),
                                    this._cacheCharacteristic(service, CONFIG_MNO_UUID          ),
                                    this._cacheCharacteristic(service, CONFIG_COMMISSION_UUID   ),
                                    this._cacheCharacteristic(service, CONFIG_CONTROL_UUID      ),
                                    this._cacheCharacteristic(service, MODEM_DEBUG_UUID         ),
                                    this._cacheCharacteristic(service, CONFIG_FACTORT_RESET_UUID),
                                    this._cacheCharacteristic(service, CONFIG_REBOOT_UUID       ),
                                    this._cacheCharacteristic(service, CONFIG_MISC_UUID         ),
                                ])
                            }),
                            server.getPrimaryService('battery_service').then(service => {
                                return this._cacheCharacteristic(service, 'battery_level')
                            }),
                            server.getPrimaryService('device_information').then(service => {
                                return Promise.all([
                                    this._cacheCharacteristic(service, 'firmware_revision_string'),
                                    this._cacheCharacteristic(service, 'manufacturer_name_string'),
                                ])
                            }),
                        ]);
                    })
                    .then( (d) => {
                        document.querySelector("#lbl-connected").textContent = "Connected!";
                    });
            }

            async disconnect() {
                if (this.device) {
                    log('Disconnecting from Bluetooth Device...');
                    if (this.device.gatt.connected) {
                        await this.device.gatt.disconnect();
                        document.querySelector("#lbl-connected").textContent = "Not Connected!";
                    } else {
                        log('> Bluetooth Device is already disconnected');
                    }
                }
            }

            /* Optima Service */  
            getDeviceName() {
                return this._readCharacteristicValue(CANDLE_DEVICE_NAME_UUID)
                    .then(this._decodeString);
            }
            setDeviceName(name) {
                let data = this._encodeString(name);
                return this._writeCharacteristicValue(CANDLE_DEVICE_NAME_UUID, data)
            }
            // Uplink
            getUplink() {
                return this._readCharacteristicValue(CONFIG_HB_INT_UUID)
                    .then(data => data.getUint8(0));
            }
            setUplink(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_HB_INT_UUID, new Uint8Array(dat))
            }
            // Sense/tilt interval
            getSenseInt() {
                return this._readCharacteristicValue(CONFIG_SENSE_UUID)
                    .then(data => data.getUint16(0));
            }
            setSenseInt(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_SENSE_UUID, new Uint8Array(dat))
                // return this._writeCharacteristicValue(CONFIG_SENSE_UUID, new Uint16Array(dat))
            }
            // Commission enable
            getCommish() {
                return this._readCharacteristicValue(CONFIG_COMMISSION_UUID)
                    .then(data => data.getUint8(0));
            }
            setCommish(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_COMMISSION_UUID, new Uint8Array(dat))
            }
            // GPS
            getGps() {
                return this._readCharacteristicValue(CONFIG_GPS_INT_UUID)
                    .then(data => data.getUint8(0));
            }
            setGps(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_GPS_INT_UUID, new Uint8Array(dat))
            }
            // MNO
            getMno() {
                return this._readCharacteristicValue(CONFIG_MNO_UUID)
                    .then(data => data.getUint8(0));
            }
            setMno(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_MNO_UUID, new Uint8Array(dat))
            }

            // Misc app config
            getAnalog() {
                return this._readCharacteristicValue(CONFIG_MISC_UUID);
            }
            setAnalog(buffer) {
                return this._writeCharacteristicValue(CONFIG_MISC_UUID, new Uint8Array(buffer) );
            }

            // APN
            async getApn() {
                return await this._readCharacteristicValue(CONFIG_APN_UUID).then(this._decodeString);
            }
            setApn(s) {
                return this._writeCharacteristicValue(CONFIG_APN_UUID, encoder.encode(s) )
            }
            // URL
            async getUrl() {
                let url = await this._readCharacteristicValue(CONFIG_URL_UUID).then(this._decodeString);
                let prt = await this._readCharacteristicValue(CONFIG_PORT_UUID).then(data => data.getUint16(0));
                return {
                    url: url,
                    port: prt
                };
            }
            setUrl(s) {
                return this._writeCharacteristicValue(CONFIG_URL_UUID, encoder.encode(s.url) )
                .then(() => {
                        let prt = [s.port];
                        return this._writeCharacteristicValue(CONFIG_PORT_UUID, new Uint16Array(prt))
                    })
            }
            // Test action
            async getTestAction() {
                return await this._readCharacteristicValue(CONFIG_CONTROL_UUID)
                .then(data => this._swap32(data.getInt32(0)) );
            }
            setTestAction(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(CONFIG_CONTROL_UUID, new Uint32Array(dat))
            }
            // Diagnostic action
            setDiagAction(interval) {
                let dat = [interval];
                return this._writeCharacteristicValue(MODEM_DEBUG_UUID, new Uint8Array(dat))
            }
            // Factory reset action
            setFactoryResetAction(interval) {
                return this._writeCharacteristicValue(CONFIG_FACTORT_RESET_UUID, new Uint8Array())
            }
            // Reboot action
            setRebootAction(interval) {
                return this._writeCharacteristicValue(CONFIG_REBOOT_UUID, new Uint8Array())
            }


            setColor(r, g, b) {
                let data = [0x00, r, g, b];
                return this._writeCharacteristicValue(CANDLE_COLOR_UUID, new Uint8Array(data))
                    .then(() => [r, g, b]); // Returns color when fulfilled.
            }

            /* Battery Service */

            getBatteryLevel() {
                return this._readCharacteristicValue('battery_level')
                    .then(data => data.getUint8(0));
            }

            /* Device Info Service */

            // getSerialNumber() {
            //     return this._readCharacteristicValue('serial_number_string')
            //         .then(this._decodeString);
            // }
            // getHardwareRevision() {
            //     return this._readCharacteristicValue('hardware_revision_string')
            //         .then(this._decodeString);
            // }
            getFirmwareRevision() {
                return this._readCharacteristicValue('firmware_revision_string')
                    .then(this._decodeString);
            }
            getSoftwareRevision() {
                return this._readCharacteristicValue('software_revision_string')
                    .then(this._decodeString);
            }
            getManufacturerName() {
                return this._readCharacteristicValue('manufacturer_name_string')
                    .then(this._decodeString);
            }

            /* Utils */

            _cacheCharacteristic(service, characteristicUuid) {
                return service.getCharacteristic(characteristicUuid)
                    .then(characteristic => {
                        this._characteristics.set(characteristicUuid, characteristic);
                        // log(' > ' + characteristic.uuid + ' ' + getSupportedProperties(characteristic));
                    });
            }
            _readCharacteristicValue(characteristicUuid) {
                let characteristic = this._characteristics.get(characteristicUuid);
                return characteristic.readValue()
                    .then(value => {
                        // In Chrome 50+, a DataView is returned instead of an ArrayBuffer.
                        value = value.buffer ? value : new DataView(value);
                        if (this._debug) {
                            for (var i = 0, a = []; i < value.byteLength; i++) { a.push(value.getUint8(i)); }
                            console.debug('READ', characteristic.uuid, a);
                        }
                        return value;
                    });
            }
            _writeCharacteristicValue(characteristicUuid, value) {
                let characteristic = this._characteristics.get(characteristicUuid);
                if (this._debug) {
                    console.debug('WRITE', characteristic.uuid, value);
                }
                return characteristic.writeValue(value);
            }
            _decodeString(data) {
                return decoder.decode(data);
            }
            _encodeString(data) {
                return encoder.encode(data);
            }

            _swap16(val) {
                return ((val & 0xFF) << 8)
                        | ((val >> 8) & 0xFF);
            }
            _swap32(val) {
                return ((val & 0xFF) << 24)
                    | ((val & 0xFF00) << 8)
                    | ((val >> 8) & 0xFF00)
                    | ((val >> 24) & 0xFF);
            }
        }

        var ewOptima = new EWOptima();

        function onButtonClick() {
            
            log('Requesting any Bluetooth Device...');
            
            ewOptima.connect()
            .catch(error => {
                log('Argh! ' + error);
            });
        }

        /* Utils */

        function getSupportedProperties(characteristic) {
            let supportedProperties = [];
            for (const p in characteristic.properties) {
                if (characteristic.properties[p] === true) {
                    supportedProperties.push(p.toUpperCase());
                }
            }
            return '[' + supportedProperties.join(', ') + ']';
        }

        document.querySelector('#btn-connect').addEventListener('click', function (event) {
            event.stopPropagation();
            event.preventDefault();

            if (isWebBluetoothEnabled()) {
                ChromeSamples.clearLog();
                log('Selecting a device...');
                ewOptima.connect()
                    .catch(error => {
                        log('Argh! ' + error);
                    });
            }
        });
        
        document.querySelector('#btn-disconnect').addEventListener('click', async function (event) {
            event.stopPropagation();
            event.preventDefault();

            if (isWebBluetoothEnabled()) {
                ChromeSamples.clearLog();
                log('Disconnecting');
                await ewOptima.disconnect();
            }
        });

    </script>
</body>

</html>
